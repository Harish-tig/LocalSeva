<!DOCTYPE html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shop - Local Marketplace</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Mobile Menu Button -->
    <button id="mobileMenuBtn" class="mobile-menu-btn">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-handshake"></i> LocalConnect</h2>
        <p>Welcome, <span id="userName">Alex</span></p>
      </div>

      <nav class="sidebar-nav">
        <ul>
          <li>
            <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
          </li>
        </ul>

        <div class="sidebar-section">
          <h3>My Activity</h3>
          <ul>
            <li>
              <a href="my-activity.html#serviceTaken"
                ><i class="fas fa-hand-holding-heart"></i> Service Taken</a
              >
            </li>
            <li>
              <a href="my-activity.html#serviceProvided" class="provider-only"
                ><i class="fas fa-hand-holding"></i> Service Provided</a
              >
            </li>
            <li>
              <a href="my-activity.html#boughtItems"
                ><i class="fas fa-shopping-cart"></i> Buy Items</a
              >
            </li>
            <li>
              <a href="my-activity.html#soldItems"
                ><i class="fas fa-tag"></i> Sell Items</a
              >
            </li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3>My Services</h3>
          <ul>
            <li>
              <a
                href="my-services.html"
                id="myServicesLink"
                class="provider-only"
                ><i class="fas fa-briefcase"></i> Provider Dashboard</a
              >
            </li>
          </ul>
        </div>

        <div class="sidebar-section">
          <ul>
            <li>
              <a href="#" id="logoutBtn"
                ><i class="fas fa-sign-out-alt"></i> Logout</a
              >
            </li>
          </ul>
        </div>
      </nav>

      <button
        id="closeSidebar"
        class="btn btn-outline"
        style="margin: 1.5rem; display: none"
      >
        <i class="fas fa-times"></i> Close
      </button>
    </div>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <a href="mart.html" class="btn btn-outline btn-sm">
            <i class="fas fa-arrow-left"></i> Back to Categories
          </a>
        </div>
        <div class="header-actions">
          <button id="themeToggle" class="theme-toggle">
            <i class="fas fa-moon"></i>
          </button>
        </div>
      </div>

      <h1>Browse Products</h1>

      <!-- Filters -->
      <div class="filters-container">
        <div class="filter-group">
          <label for="shopSearch" class="form-label">Search</label>
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input
              type="text"
              id="shopSearch"
              class="search-input"
              placeholder="Search products..."
            />
          </div>
        </div>

        <div class="filter-group">
          <label for="shopCategoryFilter" class="form-label">Category</label>
          <select id="shopCategoryFilter" class="form-control">
            <option value="">All Categories</option>
            <option value="Electronics">Electronics</option>
            <option value="Furniture">Furniture</option>
            <option value="Clothing">Clothing</option>
            <option value="Books">Books</option>
            <option value="Vehicles">Vehicles</option>
            <option value="Sports">Sports</option>
            <option value="Home Appliances">Home Appliances</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="shopLocationFilter" class="form-label">Location</label>
          <select id="shopLocationFilter" class="form-control">
            <option value="">All Locations</option>
            <option value="Downtown">Downtown</option>
            <option value="Eastside">Eastside</option>
            <option value="Westside">Westside</option>
            <option value="Uptown">Uptown</option>
            <option value="Midtown">Midtown</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="sortBy" class="form-label">Sort By</label>
          <select id="sortBy" class="form-control">
            <option value="recent">Most Recent</option>
            <option value="price_low">Price: Low to High</option>
            <option value="price_high">Price: High to Low</option>
            <option value="rating">Highest Rated</option>
          </select>
        </div>

        <div class="filter-group" style="align-self: flex-end">
          <button id="clearShopFilters" class="btn btn-outline btn-sm">
            <i class="fas fa-times"></i> Clear
          </button>
        </div>
      </div>

      <!-- Active Filter Chips -->
      <div id="filterChips" class="filter-chips">
        <!-- Filter chips will be added here dynamically -->
      </div>

      <!-- Products Grid -->
      <div id="productsContainer" class="cards-grid">
        <!-- Products will be loaded here by JavaScript -->
      </div>

      <!-- Pagination -->
      <div
        class="pagination"
        style="margin-top: 2rem; display: flex; justify-content: center"
      >
        <button class="btn btn-outline btn-sm" id="prevPage" disabled>
          <i class="fas fa-chevron-left"></i> Previous
        </button>
        <span style="margin: 0 1rem; display: flex; align-items: center">
          Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
        </span>
        <button class="btn btn-outline btn-sm" id="nextPage" disabled>
          Next <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="services.html">
        <i class="fas fa-th-large"></i>
        <span>Services</span>
      </a>
      <a href="add-item.html" class="sell-btn">
        <i class="fas fa-plus"></i>
      </a>
      <a href="mart.html" class="active">
        <i class="fas fa-store"></i>
        <span>Mart</span>
      </a>
    </nav>

    <!-- Scripts -->
    <!-- <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/mart.js"></script> -->

    <!-- <style>
      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 2rem;
      }

      .pagination-info {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }
    </style>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get("category");
        const search = urlParams.get("search");

        // Set initial filter values from URL
        if (category) {
          const categoryFilter = document.getElementById("shopCategoryFilter");
          if (categoryFilter) categoryFilter.value = category;
        }

        if (search) {
          const searchInput = document.getElementById("shopSearch");
          if (searchInput) searchInput.value = search;
        }

        // Load products
        loadProducts();

        // Initialize pagination
        let currentPage = 1;
        let totalPages = 1;

        // Filter event listeners
        const searchInput = document.getElementById("shopSearch");
        const categoryFilter = document.getElementById("shopCategoryFilter");
        const locationFilter = document.getElementById("shopLocationFilter");
        const sortBy = document.getElementById("sortBy");
        const clearFiltersBtn = document.getElementById("clearShopFilters");
        const prevPageBtn = document.getElementById("prevPage");
        const nextPageBtn = document.getElementById("nextPage");

        // Debounced search
        let searchTimer;
        if (searchInput) {
          searchInput.addEventListener("input", function () {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
              currentPage = 1;
              loadProducts();
            }, 300);
          });
        }

        // Other filter changes
        [categoryFilter, locationFilter, sortBy].forEach((filter) => {
          if (filter) {
            filter.addEventListener("change", () => {
              currentPage = 1;
              loadProducts();
            });
          }
        });

        // Clear filters
        if (clearFiltersBtn) {
          clearFiltersBtn.addEventListener("click", function () {
            if (searchInput) searchInput.value = "";
            if (categoryFilter) categoryFilter.value = "";
            if (locationFilter) locationFilter.value = "";
            if (sortBy) sortBy.value = "recent";

            // Update URL without reload
            const url = new URL(window.location);
            url.search = "";
            window.history.replaceState({}, "", url);

            currentPage = 1;
            loadProducts();
          });
        }

        // Pagination
        if (prevPageBtn) {
          prevPageBtn.addEventListener("click", function () {
            if (currentPage > 1) {
              currentPage--;
              loadProducts();
            }
          });
        }

        if (nextPageBtn) {
          nextPageBtn.addEventListener("click", function () {
            if (currentPage < totalPages) {
              currentPage++;
              loadProducts();
            }
          });
        }

        async function loadProducts() {
          const container = document.getElementById("productsContainer");
          if (!container) return;

          // Show loading state
          container.innerHTML = `
                    <div class="loading-skeleton" style="height: 250px; border-radius: var(--border-radius); grid-column: 1 / -1;"></div>
                    <div class="loading-skeleton" style="height: 250px; border-radius: var(--border-radius);"></div>
                    <div class="loading-skeleton" style="height: 250px; border-radius: var(--border-radius);"></div>
                `;

          // Get filter values
          const filters = {
            page: currentPage,
            limit: 12,
          };

          if (searchInput && searchInput.value) {
            filters.search = searchInput.value;
          }

          if (categoryFilter && categoryFilter.value) {
            filters.category = categoryFilter.value;
          }

          if (locationFilter && locationFilter.value) {
            filters.location = locationFilter.value;
          }

          if (sortBy && sortBy.value) {
            filters.sortBy = sortBy.value;
          }

          try {
            // API PLACEHOLDER: Get products with pagination
            const response = await api.getProducts(filters);

            // In a real API, response would include pagination metadata
            const products = response.products || response;
            totalPages = response.totalPages || 1;

            // Update pagination UI
            document.getElementById("currentPage").textContent = currentPage;
            document.getElementById("totalPages").textContent = totalPages;

            if (prevPageBtn) {
              prevPageBtn.disabled = currentPage <= 1;
            }

            if (nextPageBtn) {
              nextPageBtn.disabled = currentPage >= totalPages;
            }

            // Check if we have products
            if (!products || products.length === 0) {
              container.innerHTML = `
                            <div class="empty-state" style="grid-column: 1 / -1;">
                                <i class="fas fa-search"></i>
                                <h3>No products found</h3>
                                <p>Try adjusting your filters or check back later for new items.</p>
                                <button id="clearShopFilters" class="btn btn-outline">Clear Filters</button>
                            </div>
                        `;
              return;
            }

            // Render products
            renderProducts(products, container);

            // Update filter chips
            updateFilterChips(filters);
          } catch (error) {
            console.error("Error loading products:", error);
            container.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3>Error loading products</h3>
                            <p>Please try again later.</p>
                            <button onclick="loadProducts()" class="btn btn-outline">Retry</button>
                        </div>
                    `;
          }
        }

        function renderProducts(products, container) {
          container.innerHTML = "";

          products.forEach((product) => {
            const productCard = document.createElement("div");
            productCard.className = "card";
            productCard.innerHTML = `
                        <img src="${product.images[0]}" alt="${
              product.name
            }" class="card-img">
                        <div class="card-content">
                            <h3 class="card-title">${product.name}</h3>
                            <div class="card-meta">
                                <span><i class="fas fa-tag"></i> ${
                                  product.category
                                }</span>
                                <span><i class="fas fa-map-marker-alt"></i> ${
                                  product.location
                                }</span>
                                ${
                                  product.rating
                                    ? `<span><i class="fas fa-star"></i> ${product.rating}</span>`
                                    : ""
                                }
                            </div>
                            <p>${
                              product.description
                                ? product.description.substring(0, 100) + "..."
                                : ""
                            }</p>
                            <div class="card-footer">
                                <span class="price">${product.price}</span>
                                <a href="product-detail.html?id=${
                                  product.id
                                }" class="btn btn-primary btn-sm">
                                    View Details
                                </a>
                            </div>
                        </div>
                    `;

            container.appendChild(productCard);
          });
        }

        function updateFilterChips(filters) {
          const filterChipsContainer = document.getElementById("filterChips");
          if (!filterChipsContainer) return;

          filterChipsContainer.innerHTML = "";

          // Don't show page and limit in filter chips
          const chipFilters = { ...filters };
          delete chipFilters.page;
          delete chipFilters.limit;

          Object.entries(chipFilters).forEach(([key, value]) => {
            if (value && key !== "sortBy") {
              const chip = document.createElement("span");
              chip.className = "filter-chip";
              chip.innerHTML = `
                            <span>${key}: ${value}</span>
                            <span class="remove" data-filter="${key}">&times;</span>
                        `;

              filterChipsContainer.appendChild(chip);
            }
          });

          // Add remove functionality to chips
          filterChipsContainer
            .querySelectorAll(".remove")
            .forEach((removeBtn) => {
              removeBtn.addEventListener("click", function () {
                const filterKey = this.getAttribute("data-filter");

                // Remove the filter
                if (filterKey === "search") {
                  if (searchInput) searchInput.value = "";
                } else if (filterKey === "category") {
                  if (categoryFilter) categoryFilter.value = "";
                } else if (filterKey === "location") {
                  if (locationFilter) locationFilter.value = "";
                }

                // Reload products
                currentPage = 1;
                loadProducts();
              });
            });
        }
      });
    </script> -->

    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script src="js/mart.js"></script>
  </body>
</html>
